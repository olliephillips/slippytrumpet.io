<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>slippytrumpet.io</title>
    <link>https://slippytrumpet.io/categories/iot/index.xml</link>
    <description>Recent content on slippytrumpet.io</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en</language>
    <atom:link href="https://slippytrumpet.io/categories/iot/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Experiments with Messaging over Ethernet Frames</title>
      <link>https://slippytrumpet.io/posts/experiments-with-message-queuing-over-ethernet-frames/</link>
      <pubDate>Mon, 10 Jul 2017 17:27:33 +0100</pubDate>
      
      <guid>https://slippytrumpet.io/posts/experiments-with-message-queuing-over-ethernet-frames/</guid>
      <description>

&lt;h2 id=&#34;in-his-article-network-protocol-breakdown-ethernet-and-go-https-medium-com-mdlayher-network-protocol-breakdown-ethernet-and-go-de985d726cc1-matt-layher-describes-the-ethernet-protocol-and-introduces-a-couple-of-libraries-written-in-go&#34;&gt;In his article, &lt;a href=&#34;https://medium.com/@mdlayher/network-protocol-breakdown-ethernet-and-go-de985d726cc1&#34;&gt;Network Protocol Breakdown: Ethernet and Go&lt;/a&gt;, Matt Layher describes the Ethernet protocol and introduces a couple of libraries written in Go.&lt;/h2&gt;

&lt;p&gt;I read the article with interest. Application communication, at the Ethernet frame level, a lower level than TCP sockets, was something I&amp;rsquo;d never considered before.&lt;/p&gt;

&lt;p&gt;Of particular interest was the &amp;ldquo;broadcast&amp;rdquo; nature of the communication. In contrast to sockets - though frames can also be addressed to specific devices - frames can be broadcast network-wide, enabling more than one device to listen and use the frame payload.&lt;/p&gt;

&lt;p&gt;I could see some parallels between Ethernet frames and MQTT, a protocol I use frequently in my hardware projects.&lt;/p&gt;

&lt;p&gt;I could also see a few distinct advantages over MQTT. I don&amp;rsquo;t want to go into loads of detail here, but, suffice to say, a cheap, convenient but very insecure approach to using MQTT in what are often just &amp;ldquo;hobby&amp;rdquo; hardware projects, is to bounce traffic off of one of the free remote MQTT brokers. And I have been known to do this ;)&lt;/p&gt;

&lt;h2 id=&#34;so-why-ethernet-frames&#34;&gt;So why Ethernet Frames?&lt;/h2&gt;

&lt;p&gt;Potentially, by using Ethernet frames there would be no requirement for the MQTT broker so that&amp;rsquo;s one less piece of hardware to configure and manage (if you host your own); messages would stay within the local area network, behind the router firewall, so we&amp;rsquo;re secure by default and; we might achieve higher-speed transmissions, since we would not be sending data all the way off to a remote MQTT broker, only to receive it back from that broker on another machine sitting within the same local area network.&lt;/p&gt;

&lt;p&gt;So I set about writing a package on top of Matt&amp;rsquo;s &lt;a href=&#34;https://github.com/mdlayher/ethernet&#34;&gt;Ethernet&lt;/a&gt; and &lt;a href=&#34;https://github.com/mdlayher/raw&#34;&gt;Raw&lt;/a&gt; packages with two objectives in mind:-&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Use Ethernet frame messaging to emulate MQTT specifically by providing pub/sub functionality, and;&lt;/li&gt;
&lt;li&gt;Provide an API which would feel familiar to MQTT users and therefore be a relatively simple drop in replacement for a typical MQTT client library.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;methodology&#34;&gt;Methodology&lt;/h2&gt;

&lt;p&gt;The package itself is fairly straightforward - most of the sophisticated stuff is performed by the two packages of Matt&amp;rsquo;s which it imports, but it satisfies both of the objectives mentioned above.&lt;/p&gt;

&lt;p&gt;I took the liberty of naming the package EFMQ (for Ethernet Frames Message Queue), and you can find it &lt;a href=&#34;http://github.com/olliephillips/efmq&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&#34;objective-1-provide-pub-sub-functionality&#34;&gt;Objective 1 - Provide Pub/Sub functionality&lt;/h3&gt;

&lt;p&gt;Pub/Sub is emulated by devices maintaining a list of their own subscriptions and comparing each received message&amp;rsquo;s topic to this list. If topic matches a subscription, the message is put on an unbuffered channel for subsequent processing. Any messages that do not match a subscription are simply discarded.&lt;/p&gt;

&lt;h3 id=&#34;objective-2-provide-an-api-similar-to-mqtt&#34;&gt;Objective 2 - Provide an API similar to MQTT&lt;/h3&gt;

&lt;p&gt;This is best illustrated by a couple of examples.&lt;/p&gt;

&lt;h4 id=&#34;publisher&#34;&gt;Publisher&lt;/h4&gt;

&lt;p&gt;In this contrived example, we&amp;rsquo;re publishing temperature data on the &lt;code&gt;temp&lt;/code&gt; topic every second. &lt;code&gt;wlan0&lt;/code&gt; represents the network interface used by the device, in this case a Raspberry Pi Zero W.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;mq, err := efmq.NewEFMQ(&amp;quot;wlan0&amp;quot;) 
if err != nil {
  log.Fatal(err)
}
t := time.NewTicker(1 * time.Second)
for range t.C {
  if err := mq.Publish(&amp;quot;temp&amp;quot;, &amp;quot;20.5&amp;quot;); err != nil {
 	log.Fatalln(err)
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;&lt;/p&gt;

&lt;h4 id=&#34;subscriber&#34;&gt;Subscriber&lt;/h4&gt;

&lt;p&gt;In this example another device in the same network subscribes to the &lt;code&gt;temp&lt;/code&gt; topic and then listens indefinitely. Any messages which match the subscription are made available on the &lt;code&gt;mq.Message&lt;/code&gt; channel.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;mq, err := efmq.NewEFMQ(&amp;quot;wlan0&amp;quot;)
if err != nil {
  log.Fatal(err)
}
mq.Subscribe(&amp;quot;fermenter&amp;quot;)
mq.Listen()
for msg := range mq.Message {
  fmt.Println(&amp;quot;topic:&amp;quot;, msg.Topic)
  fmt.Println(&amp;quot;message:&amp;quot;, msg.Payload)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;&lt;/p&gt;

&lt;h3 id=&#34;performance&#34;&gt;Performance&lt;/h3&gt;

&lt;p&gt;We&amp;rsquo;re off to a good start by removing the latency transmitting messages via a remote server, and the messaging is direct between two devices, no third device (a local MQTT broker) is needed to relay messages, but as yet I don&amp;rsquo;t have any benchmarks.&lt;/p&gt;

&lt;p&gt;In testing, I&amp;rsquo;ve been running a dummy setup using two Raspberry Pi Zero W devices which have been communicating using EFMQ at an interval of 50ms for over a week with no issues. 50ms means 20 messages per second - more than sufficient for most monitoring and control applications that I&amp;rsquo;m likely to want to build!&lt;/p&gt;

&lt;p&gt;If you give EFMQ a try please let me know how it works for you!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Running your Application as a Service on Pi Zero W</title>
      <link>https://slippytrumpet.io/posts/running-your-app-as-service-on-pi-zero-w/</link>
      <pubDate>Thu, 08 Jun 2017 10:27:15 +0100</pubDate>
      
      <guid>https://slippytrumpet.io/posts/running-your-app-as-service-on-pi-zero-w/</guid>
      <description>

&lt;h1 id=&#34;daemonize-your-application-so-that-it-is-easily-started-stopped-and-resilient-to-crashes&#34;&gt;Daemonize your application so that it is easily started, stopped and resilient to crashes&lt;/h1&gt;

&lt;p&gt;So you&amp;rsquo;ve got your headless Raspberry Pi Zero W all set up and you&amp;rsquo;ve been running applications you&amp;rsquo;ve written for yourself on it? I have, I&amp;rsquo;m using Go with a combination of &lt;a href=&#34;http://embd.kidoman.io/&#34;&gt;Embd&lt;/a&gt; and &lt;a href=&#34;https://periph.io/&#34;&gt;Periph.io&lt;/a&gt; libraries to interact with the hardware on the Pi Zero W itself and external to it.&lt;/p&gt;

&lt;p&gt;But it feels clunky.&lt;/p&gt;

&lt;p&gt;Running &amp;ldquo;headless&amp;rdquo;, with no screen or keyboard, everytime I boot the device I need to SSH to it and kick off the application from the command line.&lt;/p&gt;

&lt;p&gt;One of the apps I have monitors temperature using Onewire and two DS18B20 temperature probes. To have to SSH to the Pi Zero W to run the program that does this, is inconvenient: I need access to a computer with a Terminal, and the Pi Zero W must be accessible over the network via SSH. This won&amp;rsquo;t always be possible.&lt;/p&gt;

&lt;p&gt;Much better would be for me to simply switch on the Pi Zero W and have the program run automatically. Plug and Play.&lt;/p&gt;

&lt;p&gt;We can do this, and more, by running the program as a service, often referred to as &amp;ldquo;daemonizing&amp;rdquo;.&lt;/p&gt;

&lt;h2 id=&#34;how-to-daemonize&#34;&gt;How to daemonize?&lt;/h2&gt;

&lt;p&gt;There are &lt;a href=&#34;https://github.com/sevlyar/go-daemon&#34;&gt;Go packages that you can include in your codebase to emulate running as a service&lt;/a&gt;, and whilst I looked into these, this post does not cover them, for there is a simpler way, one which is useful for a program written in any language, not just Go.&lt;/p&gt;

&lt;h3 id=&#34;systemd&#34;&gt;systemd&lt;/h3&gt;

&lt;p&gt;systemd is a service manager for Linux which ships with Raspbian, so it&amp;rsquo;s already installed on your Pi Zero W and allows us to easilly daemonize our application.&lt;/p&gt;

&lt;p&gt;Running the application as a service has several benefits.&lt;/p&gt;

&lt;p&gt;1) We can start, stop and ascertain the status of our application service with simple commands.&lt;/p&gt;

&lt;p&gt;2) systemd will monitor and restart the service in the event our program crashes, so our application is more robust to unforseen errors and bugs.&lt;/p&gt;

&lt;p&gt;3) systemd will start the application for us once our Raspberry Pi W has booted - subject to a few constraints - so we&amp;rsquo;ll no longer need to SSH to the device to kickstart the program.&lt;/p&gt;

&lt;p&gt;Certainly sounds like the way to go!&lt;/p&gt;

&lt;h2 id=&#34;step-1-create-a-systemd-configuration-file-for-your-program&#34;&gt;Step 1 - Create a systemd configuration file for your program&lt;/h2&gt;

&lt;p&gt;systemd needs to know a few things about your application, so you need to give it a configuration file which provides the information required.&lt;/p&gt;

&lt;p&gt;Configuration files have the &lt;code&gt;.service&lt;/code&gt; extension and are stored in this location on your Pi Zero W &lt;code&gt;/etc/systemd/system/&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Change directory to &lt;code&gt;/etc/systemd/system&lt;/code&gt; and use &lt;code&gt;sudo nano&lt;/code&gt; to create a new file, with the &lt;code&gt;.service&lt;/code&gt; extension. For example I have &lt;code&gt;tempmon.service&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;In this file you need to add a few directives. This is my &lt;code&gt;tempmon.service&lt;/code&gt; file, simply amend to suit your application.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;## tempmon.service

[Unit]
Description=Temperature Monitor
After=network.target

[Service]
User=root
WorkingDirectory=/home/slippytrumpet
ExecStart=/home/slippytrumpet/tempmon
Restart=on-failure
StartLimitIntervalSec=1800

[Install]
WantedBy=multi-user.target
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
The directives, for the most part, need no explanation, but a couple bear comment.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;After=network.target&lt;/code&gt;, means systemd will run the program once networking is available.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;User=root&lt;/code&gt;, sets the user that the process is to be run as. Since my temperature monitoring application is interfacing with hardware on the Pi Zero W, it needs root privileges.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;StartLimitIntervalSec=1800&lt;/code&gt;, by default the application will be restarted if it crashes, but if it crashes more than the default of 5 times, there will be a pause of 1800 seconds (30 minutes) before systemd attempts to start it again.&lt;/p&gt;

&lt;p&gt;The MAN file for systemd contains all the directives which can be used and &lt;a href=&#34;https://www.freedesktop.org/software/systemd/man/systemd.directives.html&#34;&gt;you can find an online version of that, here&lt;/a&gt;.&lt;/p&gt;

&lt;h2 id=&#34;step-2-enable-the-config-file&#34;&gt;Step 2 - Enable the config file&lt;/h2&gt;

&lt;p&gt;To enable your new config file, so that systemd daemonizes your program, use this command (substituting the name of your file in place of &lt;code&gt;tempmon&lt;/code&gt;):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo systemctl enable tempmon
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
If you edit the file once enabled you will need to reload it with this command:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo systemctl daemon-reload
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Now if you reboot your Pi Zero W, your program will be started by systemd. You can check it&amp;rsquo;s status with the command:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo service tempmon status
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
And, you can stop and start the program just like any other Linux service:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo service tempmon stop
sudo service tempmon start
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>Web Bluetooth to MQTT Gateway with Puck.js</title>
      <link>https://slippytrumpet.io/posts/webbluetooth-to-mqtt-gateway/</link>
      <pubDate>Fri, 07 Apr 2017 12:36:46 +0100</pubDate>
      
      <guid>https://slippytrumpet.io/posts/webbluetooth-to-mqtt-gateway/</guid>
      <description>

&lt;h2 id=&#34;if-you-read-a-little-bit-of-web-bluetooth-https-slippytrumpet-io-posts-a-little-bit-of-web-bluetooth-you-ll-know-a-bit-about-puck-js-and-the-new-web-bluetooth-api-already-but-what-aside-from-building-a-gimmicky-two-factor-authentication-system-can-you-do-with-it&#34;&gt;If you read &lt;a href=&#34;https://slippytrumpet.io/posts/a-little-bit-of-web-bluetooth/&#34;&gt;A little bit of Web Bluetooth&lt;/a&gt; you&amp;rsquo;ll know a bit about Puck.js and the new Web Bluetooth API already. But what, aside from building a gimmicky two factor authentication system, can you do with it?&lt;/h2&gt;

&lt;p&gt;I had some ideas.&lt;/p&gt;

&lt;p&gt;What about an interface through which you can program multiple Pucks at the same time? The Web IDE allows you to connect and program one Puck at a time. What if I want a few doing the same thing, it would be nice to set them up in one go? We&amp;rsquo;ll call this a Console.&lt;/p&gt;

&lt;p&gt;What about a Relay - whereby one Puck controls others in a master/slave configuration? Now you can do this directly between Pucks, but we could use Web Bluetooth to make a Relay.&lt;/p&gt;

&lt;p&gt;What about individual Pucks, communicating via Web Bluetooth, with each other over the Internet using MQTT, or just controlled from a remote location with MQTT? A Gateway?&lt;/p&gt;

&lt;p&gt;Three interesting ideas: a Console, a Relay and a Gateway.&lt;/p&gt;

&lt;p&gt;So here is &lt;a href=&#34;https://olliephillips.github.io/webbleMQ/&#34;&gt;WebbleMQ&lt;/a&gt;, which is all of these things. It&amp;rsquo;s a HTML5 &amp;amp; Javascript application which allows you connect multiple Pucks.&lt;/p&gt;

&lt;p&gt;Each Puck is tracked on a connection ID, and depending on the mode that is set, it lets you interact with the connected Pucks in different ways.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://slippytrumpet.io/images/webblemq.png&#34; alt=&#34;alt text&#34; title=&#34;The WebbleMQ Interface&#34; /&gt;
Pictured. The WebbleMQ interface&lt;/p&gt;

&lt;p&gt;Though I wrote it specifically for Puck.js, the Web Bluetooth API connection filter is quite broad. It looks for devices which, like the Puck, support the NORDIC UART bluetooth service. So it could well work for other devices which support this service. I haven&amp;rsquo;t tested.&lt;/p&gt;

&lt;p&gt;The source code for the application, as well as being readable in the web page, &lt;a href=&#34;https://github.com/olliephillips/webbleMQ&#34;&gt;can also be found on Github here&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&#34;relay-mode&#34;&gt;Relay mode&lt;/h3&gt;

&lt;p&gt;One device, operating as Master, can control several devices which are configured as Slaves.&lt;/p&gt;

&lt;p&gt;For example, it&amp;rsquo;s simple to turn the Pucks&amp;rsquo; onboard LEDs on and off with a program running on master device such as this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;var prog1 = &amp;quot;LED1.set();LED2.set();LED3.set();\n&amp;quot;;
var prog2 = &amp;quot;LED1.reset();LED2.reset();LED3.reset();\n&amp;quot;;
var on = false;
setInterval(function(){
  var prog = prog2;
  if(!on){prog = prog1;}
  Bluetooth.write(prog);
  on = !on;
}, 5000);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;&lt;/p&gt;

&lt;h3 id=&#34;console-mode&#34;&gt;Console mode&lt;/h3&gt;

&lt;p&gt;In Console mode, all devices listen to input from the console. We can programatically control several devices at once, we just key our commands to the console window and the code is passed to, and executed on, all connected Pucks.&lt;/p&gt;

&lt;h3 id=&#34;mqtt-modes-the-fun-stuff&#34;&gt;MQTT modes. The fun stuff&lt;/h3&gt;

&lt;p&gt;We&amp;rsquo;ve two modes available here, &amp;ldquo;Announced&amp;rdquo; and &amp;ldquo;Unannounced&amp;rdquo;. I&amp;rsquo;ll explain the difference, but to be clear, neither mode is secure.&lt;/p&gt;

&lt;p&gt;The MQTT broker used by default is the public &lt;code&gt;iot.eclipse.org&lt;/code&gt; broker and though the topic ids used for publishing on are quite obscure in their format, e.g. &lt;code&gt;/wmq/pub/t7fldnrthv205btnafjzg&lt;/code&gt;, this is not secure. If someone knows or guesses the topic id, they can listen and send on the same topic too. Don&amp;rsquo;t send your bank details :)&lt;/p&gt;

&lt;p&gt;That said, if you need security, you could fork the application and change the MQTT broker to one which provides authentication. I didn&amp;rsquo;t need.&lt;/p&gt;

&lt;h3 id=&#34;mqtt-unannounced&#34;&gt;MQTT &amp;ldquo;unannounced&amp;rdquo;&lt;/h3&gt;

&lt;p&gt;In this mode each device has its own publish topic and subscribe topic. If you connect multiple Pucks, then Pucks can subscribe to another Puck&amp;rsquo;s publish topic, so they&amp;rsquo;d in effect be listening to it.&lt;/p&gt;

&lt;h3 id=&#34;mqtt-announced&#34;&gt;MQTT &amp;ldquo;announced&amp;rdquo;&lt;/h3&gt;

&lt;p&gt;Same as above, but device advertises its presence, both the topic it is publishing on and subscribed to, every 10 seconds on a third topic: &lt;code&gt;/wmq/playing&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;This topic is used by all connected devices in MQTT announced mode. So, in announced mode someone could check this topic and find pucks they could control, those users happy to allow their Puck to be controlled remotely over MQTT.&lt;/p&gt;

&lt;h2 id=&#34;that-s-it&#34;&gt;That&amp;rsquo;s it&lt;/h2&gt;

&lt;p&gt;The appilication is not without a few glitches, it was a weekends work, and primarilly a proof of concept to help me get familiar with Web Bluetooth.&lt;/p&gt;

&lt;p&gt;It could be improved. For example a free text box rather than select for MQTT topic would allow subscriptions to Pucks found publishing in &lt;code&gt;wmq/playing&lt;/code&gt;. Better yet a check of the &lt;code&gt;wmq/playing&lt;/code&gt; topic which adds all available devices to the publish and subscribe select box options. Feel free to fork it and send pull requests.&lt;/p&gt;

&lt;p&gt;It&amp;rsquo;s not especially practical either. You have to have a computer running a Chrome Browser in order to let your Pucks communicate over MQTT. A proper gateway would be a server application on a Raspeberry Pi for example.&lt;/p&gt;

&lt;p&gt;But it is, hopefully, a bit of fun, which other Puck owners might want to experiment with, and which shows off the potential of Web Bluetooth a little more.&lt;/p&gt;

&lt;p&gt;Enjoy!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Raspberry Pi Zero W &#34;headless&#34; Setup</title>
      <link>https://slippytrumpet.io/posts/raspberry-pi-zero-w-setup/</link>
      <pubDate>Fri, 17 Mar 2017 16:06:50 +0000</pubDate>
      
      <guid>https://slippytrumpet.io/posts/raspberry-pi-zero-w-setup/</guid>
      <description>

&lt;p&gt;&lt;img src=&#34;https://thingiverse-production-new.s3.amazonaws.com/renders/ee/4c/d9/f7/3d/326e57726fc5c2070bc5c19417e1814d_preview_featured.jpeg&#34; alt=&#34;alt text&#34; title=&#34;Pi Zero rack/stand&#34; /&gt;
Pictured: My Raspberry Pi Zero W stand/rack. &lt;a href=&#34;https://www.thingiverse.com/thing:2169943&#34;&gt;Get it on Thingiverse&lt;/a&gt;&lt;/p&gt;

&lt;h1 id=&#34;an-end-to-end-log-of-the-set-up-process-i-followed-from-my-macbook&#34;&gt;An end-to-end log of the set-up process I followed from my Macbook&lt;/h1&gt;

&lt;h2 id=&#34;what-s-this-all-about&#34;&gt;What&amp;rsquo;s this all about?&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;Setting up a Raspberry Pi Zero W in a &amp;ldquo;headless&amp;rdquo; configuration, without a keyboard or monitor;&lt;/li&gt;
&lt;li&gt;Configuring access to multiple Wifi access points;&lt;/li&gt;
&lt;li&gt;Securing via passwordless SSH public key only login and Firewall rules configuration;&lt;/li&gt;
&lt;li&gt;Simple command line Terminal access by configuring Hostname/Hosts;&lt;/li&gt;
&lt;li&gt;Creating a custom image, which we can reuse next time we want to configure another Pi Zero W.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;To use the information here, you will need a Micro SD card, a full size adapter and an SD card USB drive, and of course, a Rasberry Pi Zero W.&lt;/p&gt;

&lt;h2 id=&#34;why-raspberry-pi-zero-w&#34;&gt;Why Raspberry Pi Zero W?&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://www.raspberrypi.org/products/pi-zero/&#34;&gt;Raspberry Pi Zero W&lt;/a&gt; is a small, powerful and connected (onboard Wifi and Bluetooth) computer.  It&amp;rsquo;s the only Raspberry Pi that&amp;rsquo;s really caught my attention, including the original &amp;lsquo;unconnected&amp;rsquo; Pi Zero.&lt;/p&gt;

&lt;p&gt;It&amp;rsquo;s small; not much bigger than a NodeMCU &lt;a href=&#34;https://en.wikipedia.org/wiki/ESP8266&#34;&gt;ESP8266&lt;/a&gt; Wifi board, but the Pi Zero W also offers Bluetooth as well as better processor, RAM and storage resources.&lt;/p&gt;

&lt;p&gt;It&amp;rsquo;s cheap; just launched but only 9GBP. It will give &lt;a href=&#34;https://en.wikipedia.org/wiki/ESP32&#34;&gt;ESP32&lt;/a&gt; something to think on, a board which also has Wifi and Bluetooth, but to buy in a developer friendly form, &amp;lsquo;currently&amp;rsquo; costs a bit more.&lt;/p&gt;

&lt;p&gt;It&amp;rsquo;s available; in the week it launched I ordered one, and I had it in my hands 2 days later. This makes it a strong contender in the space &lt;a href=&#34;https://getchip.com/&#34;&gt;C.H.I.P&lt;/a&gt; has positioned for itself, which, though arguably a better board with 4GB of onboard storage, is in very short supply.&lt;/p&gt;

&lt;p&gt;It runs Linux; so, much of the stuff I do day-to-day is portable to the Pi Zero W.&lt;/p&gt;

&lt;p&gt;It runs Go; Go compiles for lots of platforms, but STM32 architectures are not supported - the binaries are too big. So I can&amp;rsquo;t use Go on ESP8266 boards, and I have no clue about programming in C. Fortunately for me, Go cross compiles to the Pi Zero W ARM architecture, just fine.&lt;/p&gt;

&lt;h2 id=&#34;going-headless&#34;&gt;Going &amp;ldquo;headless&amp;rdquo;&lt;/h2&gt;

&lt;p&gt;I&amp;rsquo;m shooting for a &amp;ldquo;headless&amp;rdquo; setup. No screen and no monitor or other peripherals. I want to access my Pi Zero W like I do servers - over SSH.&lt;/p&gt;

&lt;p&gt;You can connect a monitor and keyboard initially to configure everything, but since I don&amp;rsquo;t have either spare, I&amp;rsquo;m doing it without.&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;m on a Mac, so this log is Mac focussed. It would be easier on Linux - as you&amp;rsquo;ll see :)&lt;/p&gt;

&lt;h2 id=&#34;we-shoud-start&#34;&gt;We shoud start!&lt;/h2&gt;

&lt;p&gt;What follows is my set-up process, end to end. You should be able to follow it verbatim.&lt;/p&gt;

&lt;p&gt;I didn&amp;rsquo;t know some of this information initially, I used a couple of web resources myself in piecing it together. I&amp;rsquo;ve provided links to these resources where relevant.&lt;/p&gt;

&lt;h3 id=&#34;step-1-download-raspbian-linux-image-and-make-a-bootable-micro-sd-card&#34;&gt;Step 1. Download Raspbian Linux image and make a bootable Micro SD card&lt;/h3&gt;

&lt;p&gt;We need a blank Micro SD card and adapter. And 8GB card seems to be the minimum requirement.&lt;/p&gt;

&lt;p&gt;For a headless configuration we don&amp;rsquo;t need the Pixel GUI/desktop that bundles with the full image, so we can grab the smaller &amp;lsquo;lite&amp;rsquo; image. At time of writing latest was &amp;lsquo;Jessie&amp;rsquo;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://www.raspberrypi.org/downloads/raspbian/&#34;&gt;Download it here&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Run this command in Terminal, prefix with &lt;code&gt;sudo&lt;/code&gt; if you need to:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;diskutil list
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Note the lines in the output like these:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;/dev/disk0 (internal, physical):
/dev/disk1 (internal, virtual):
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Plug the Micro SD card into the adapter and insert it into your SD card slot. Run the same command again. You should see an additional line in the output:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;/dev/disk0 (internal, physical):
/dev/disk1 (internal, virtual):
/dev/disk2 (internal, physical):
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
The additional line is your Micro SD card.&lt;/p&gt;

&lt;p&gt;Next, we&amp;rsquo;ll unmount it, ready for flashing.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo diskutil unmountdisk /dev/disk2
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
In Terminal, change directory to where you have the downloaded Raspbian Jessie Lite image, which for me was Downloads:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cd ~/Downloads
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Use the &lt;code&gt;dd&lt;/code&gt; command to copy the image to the Micro SD card. Note our use of &lt;code&gt;rdisk2&lt;/code&gt; rather than &lt;code&gt;disk2&lt;/code&gt;. This means &amp;lsquo;raw disk&amp;rsquo; and is supposed to be faster.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo dd bs=1m if=2017-03-02-raspbian-jessie-lite.img of=/dev/rdisk2
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
You&amp;rsquo;ll loose your Terminal prompt. Wait for the process to complete.&lt;/p&gt;

&lt;p&gt;We now have a bootable Micro SD card.&lt;/p&gt;

&lt;p&gt;We could stick it in the Pi Zero W and boot it right away, but this wouldn&amp;rsquo;t do us much good. With no keyboard or monitor, nor any network connectivity we can&amp;rsquo;t interact with it yet.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;EDIT: 05/12/2017.&lt;/strong&gt; There are a couple of useful comments at the bottom of this post which suggest the process I describe next, including the need to create a virtual machine later on, can be simplified in general, and especially for Mac users on later versions of OS X. I haven&amp;rsquo;t had the opportunity to try for myself, but I&amp;rsquo;d encourage you to check that information out also.&lt;/p&gt;

&lt;h3 id=&#34;step-2-access-the-raspbian-linux-image-to-edit-files&#34;&gt;Step 2. Access the Raspbian Linux image to edit files&lt;/h3&gt;

&lt;p&gt;The Raspbian image comprises two sub-partitions; a boot partition which is formatted as FAT32 and the file system partition, of type LINUX.&lt;/p&gt;

&lt;p&gt;If we mount and inspect the SD card in our Mac&amp;rsquo;s Finder, we can only access the BOOT sub-partition. The LINUX filesystem partition is EXT4 format and our Mac Finder can&amp;rsquo;t see/use it.&lt;/p&gt;

&lt;p&gt;We can&amp;rsquo;t mount the sub-partition in Terminal either on Mac, so we need to use Linux.&lt;/p&gt;

&lt;p&gt;A virtual machine is convenient here.&lt;/p&gt;

&lt;p&gt;On Mac, an easy way to create a Linux virtual machine is via &lt;a href=&#34;https://www.vagrantup.com/&#34;&gt;Vagrant&lt;/a&gt; and &lt;a href=&#34;https://www.virtualbox.org/&#34;&gt;VirtualBox&lt;/a&gt;, and &lt;a href=&#34;https://www.jeffgeerling.com/blogs/jeff-geerling/mounting-raspberry-pis-ext4-sd&#34;&gt;I mostly used this guide, by Jeff Geerling&lt;/a&gt; for this part of the process.&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://www.vagrantup.com/downloads.html&#34;&gt;Install Vagrant&lt;/a&gt;, which will install the VirtualBox dependency.&lt;/p&gt;

&lt;p&gt;Grab a recent Ubuntu Linux image using &lt;code&gt;vagrant init&lt;/code&gt; and start the virtual machine.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;vagrant init bento/ubuntu-16.04
vagrant up
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Suspend it.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;vagrant suspend
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Launch VirtualBox, find the virtual machine and discard the saved state (via the right click option). We need to do this so that we can enable USB.&lt;/p&gt;

&lt;p&gt;Right click again and select &amp;lsquo;Settings&amp;rsquo;. Choose &amp;lsquo;Ports&amp;rsquo; and &amp;lsquo;USB&amp;rsquo; then check &amp;lsquo;Enable USB Controller&amp;rsquo;.&lt;/p&gt;

&lt;p&gt;Plug the USB SD flash drive into one of the USB ports. Insert the Micro SD card (with the adapter if required) into the USB SD flash drive.&lt;/p&gt;

&lt;p&gt;Check in Mac Finder that the card has not been mounted. If it has, unmount it.&lt;/p&gt;

&lt;p&gt;Start the virtual machine from within VirtualBox and login as the &lt;code&gt;vagrant&lt;/code&gt; user:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;vagrant login: vagrant
Password: vagrant
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Click the USB option in the virtual machine window and select the USB Mass Storage device, which represents the USB SD flash drive/Micro SD card to give the virtual machine access to this drive.&lt;/p&gt;

&lt;p&gt;If it is not selectable, double check in Finder that it has not been mounted.&lt;/p&gt;

&lt;p&gt;Key the following in the virtual machine&amp;rsquo;s Terminal prompt.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo fdisk -l
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
This should identify both sub-partitions on the Micro SD card.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Device          Type
/dev/sdb1       Win95 FAT32 (LBA)
/dev/sdb2       Linux
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Mount the Linux sub-partition and change into this directory.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo mount /dev/sdb2 /media/usb
cd /media/usb
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
We now have access and can edit files.&lt;/p&gt;

&lt;h3 id=&#34;step-3-edit-files-to-pre-configure-wifi&#34;&gt;Step 3. Edit files to pre-configure Wifi&lt;/h3&gt;

&lt;p&gt;The next step is to configure Wifi, so that when booted our Pi Zero W will connect to a network.&lt;/p&gt;

&lt;p&gt;I typically operate between two Wifi access points, so I have set up both in the configuration below.&lt;/p&gt;

&lt;p&gt;Maybe you only need to connect to one access point? I&amp;rsquo;d still recommend the configuration below, since it&amp;rsquo;s extensible - there if/when you need it.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo nano etc/wpa_supplicant/wpa_supplicant.conf 
## Note no preceding &amp;quot;/&amp;quot;. 
## Want to edit file on image not the virtual machine
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
I&amp;rsquo;m working between two access points so configured &lt;code&gt;wpa_supplicant.conf&lt;/code&gt; like this.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;country=GB
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1

network={
    ssid=&amp;quot;SSID_OF_NETWORK_1&amp;quot;
    psk=&amp;quot;password&amp;quot;
    id_str=&amp;quot;home&amp;quot;
}

network={
    ssid=&amp;quot;SSID_OF_NETWORK_2&amp;quot;
    psk=&amp;quot;password&amp;quot;
    id_str=&amp;quot;work&amp;quot;
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Key &lt;code&gt;Ctrl+x&lt;/code&gt; to  confirm and save.&lt;/p&gt;

&lt;p&gt;We need to make amendments to &lt;code&gt;etc/network/interfaces&lt;/code&gt; also.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo nano etc/network/interfaces
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
The defaults in here need to be amended for multiple access points and roaming between them.&lt;/p&gt;

&lt;p&gt;Again this is my configuration, but a redundant config for a second unused access point should not hurt you - and you may need it later.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;source-directory /etc/network/interfaces.d

auto lo
iface lo inet loopback

iface eth0 inet manual

allow-hotplug wlan0
iface wlan0 inet manual
    wpa-roam /etc/wpa_supplicant/wpa_supplicant.conf

allow-hotplug wlan1
iface wlan1 inet manual
    wpa-roam /etc/wpa_supplicant/wpa_supplicant.conf

iface home inet dhcp
iface work inet dhcp
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Save the file.&lt;/p&gt;

&lt;p&gt;Unmount the Micro SD card in the SD card flash drive.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cd ../../
sudo umount /media/usb
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Next, we need to make a single amend to the first boot partition of the Micro SD card, since by default the SSH service is not enabled on Pi Zero.&lt;/p&gt;

&lt;p&gt;So we&amp;rsquo;ll create an empty file named &lt;code&gt;SSH&lt;/code&gt; with no extension. This is deleted at first boot, but SSH is subsequently enabled.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo mount /dev/sdb1 /media/usb
cd /media/usb
sudo touch SSH
cd ../../
sudo umount /media/usb
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Insert the Micro SD card into your Pi Zero W and power it up. If all went well you&amp;rsquo;ll connect to an access point. If you configured a second access point, when you go to your second location you&amp;rsquo;ll automatically connect to that access point too.&lt;/p&gt;

&lt;p&gt;Hopefully, it should be evident how to add a third access point (or more) if needed.&lt;/p&gt;

&lt;h3 id=&#34;step-4-configure-passwordless-login-over-ssh&#34;&gt;Step 4. Configure passwordless login over SSH&lt;/h3&gt;

&lt;p&gt;Now we have networking we can connect to the Pi Zero W itself over SSH.&lt;/p&gt;

&lt;p&gt;You can find the IP address of the Pi Zero W by logging into your router and looking at the list of attached devices.&lt;/p&gt;

&lt;p&gt;Alternatively, many routers with DHCP allocate an IP and expose the Pi Zero on the hostname &lt;code&gt;raspberrypi.local&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;In Terminal, let&amp;rsquo;s try connect to it.&lt;/p&gt;

&lt;p&gt;The default user is &lt;code&gt;pi&lt;/code&gt; the default password is &lt;code&gt;raspberry&lt;/code&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;ssh pi@raspberrypi.local // or ip address
password: raspberry
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Default passwords are never good. Let&amp;rsquo;s sort, for both the &lt;code&gt;root&lt;/code&gt; and &lt;code&gt;pi&lt;/code&gt; users, by changing them.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo passwd root
Enter new UNIX password: verylongpasswdyoucannotsee
passwd: password updated successfully

passwd
(current) UNIX password: raspberry
Enter new UNIX password: verylongpasswdyoucannotsee
passwd: password updated successfully
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Update and upgrade Raspbian, this takes a few minutes to complete. Hit &lt;code&gt;y&lt;/code&gt; in response to any prompts.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo apt-get update
sudo apt-get upgrade
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br&gt;
Next we&amp;rsquo;re going to set up SSH passwordless login. This is done by transferring our public key from our Mac to a special location on the Pi Zero W.&lt;/p&gt;

&lt;p&gt;If you&amp;rsquo;re a developer, it&amp;rsquo;s very likely you&amp;rsquo;ll have a private/public key pair already on your Mac, but if not, &lt;a href=&#34;https://docs.joyent.com/public-cloud/getting-started/ssh-keys/generating-an-ssh-key-manually/manually-generating-your-ssh-key-in-mac-os-x&#34;&gt;you&amp;rsquo;ll need to create one&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;On your Pi Zero W create the following folder in your home directory.
&lt;br/&gt;
Then set the permissions.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;mkdir /home/pi/.ssh
chmod 700 /home/pi/.ssh
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Create the &lt;code&gt;authorized_keys&lt;/code&gt; file, and copy over your public key. You need to copy the contents of &lt;code&gt;~/.ssh/id_rsa.pub&lt;/code&gt; into this file.
&lt;br/&gt;
Then set the permissions.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;nano /home/pi/.ssh/authorized_keys
chmod 400 /home/pi/.ssh/authorized_keys
chown -R pi:pi /home/pi
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Open a new Terminal window - !! do not close the current window !!&lt;/p&gt;

&lt;p&gt;Attempt to connect.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;ssh pi@raspberrypi.local
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
This time we should log straight in to our Pi Zero W without being prompted for a password.&lt;/p&gt;

&lt;p&gt;Finally, we will increase security by disabling all SSH password logins, the root user login, and restricting use of the SSH service to only the user &lt;code&gt;pi&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo nano /etc/ssh/sshd_config
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Add, or amend, the following lines in this file.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;PermitRootLogin no
PasswordAuthentication no
AllowUsers pi
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Restart the SSH service with &lt;code&gt;sudo service ssh restart&lt;/code&gt;.&lt;/p&gt;

&lt;h3 id=&#34;step-5-configure-a-firewall&#34;&gt;Step 5. Configure a Firewall&lt;/h3&gt;

&lt;p&gt;Last step was a bit intense. Step 5 is nice and easy. We&amp;rsquo;re going to install and set up a Firewall, through which we can block port access to our Pi Zero W.&lt;/p&gt;

&lt;p&gt;We&amp;rsquo;re going to install and use UFW (Uncomplicated Firewall). This application provides a super easy abstraction to iptables, an application which, personally speaking, I&amp;rsquo;ve often struggled with.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo apt-get install ufw
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Now we need to set some rules.&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;ll probably use my Pi Zero W as a webserver, maybe also as a client to consume API services, so I need HTTP and HTTPS, so I need to open ports 80 and 443.&lt;/p&gt;

&lt;p&gt;I also use &lt;a href=&#34;https://sendgrid.com/&#34;&gt;Sendgrid&lt;/a&gt; to relay server email, and that works on port 587.&lt;/p&gt;

&lt;p&gt;Obviously I&amp;rsquo;ll be using SSH to login in, and by default that uses port 22.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo ufw default deny incoming
sudo ufw allow 80
sudo ufw allow 443 
sudo ufw allow 587
sudo ufw allow 22
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Now, start UFW then check the configuration.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo ufw enable
sudo ufw status

Status: active

To                         Action      From
--                         ------      ----
22                         ALLOW       Anywhere
80                         ALLOW       Anywhere
443                        ALLOW       Anywhere
587                        ALLOW       Anywhere
22                         ALLOW       Anywhere (v6)
80                         ALLOW       Anywhere (v6)
443                        ALLOW       Anywhere (v6)
587                        ALLOW       Anywhere (v6)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br&gt;
We&amp;rsquo;re firewalled. Feels good yes?
&lt;br/&gt;
At this point our setup is fairly robust. I think so anyway.
&lt;br/&gt;
But we can do more to make using Pi Zero W a lovely experience.&lt;/p&gt;

&lt;h3 id=&#34;step-6-hostname-configuration&#34;&gt;Step 6. Hostname configuration&lt;/h3&gt;

&lt;p&gt;I bet you, like me, have more than one Raspberry Pi Zero W - or will have soon!&lt;/p&gt;

&lt;p&gt;They&amp;rsquo;re handy things, and cheap.&lt;/p&gt;

&lt;p&gt;But, if we&amp;rsquo;re going to use more than one Pi Zero W on the same Wifi network, we have a small problem.&lt;/p&gt;

&lt;p&gt;Unless we want to keep identifying them by IP address, which means checking the router&amp;rsquo;s attached device list, we need a way to tell them apart, as, by default, they all have the hostname of &lt;code&gt;raspberrypi&lt;/code&gt;, addressed as &lt;code&gt;raspberrypi.local&lt;/code&gt; over SSH.&lt;/p&gt;

&lt;p&gt;This is not useful. So let&amp;rsquo;s change it - it&amp;rsquo;s simple.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo nano /etc/hostname
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;&lt;/p&gt;

&lt;p&gt;Replace the &lt;code&gt;raspberrypi&lt;/code&gt; value in this file with the name you want. There are restrictions on what &lt;code&gt;hostname&lt;/code&gt; can be, but I name/number mine like this.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;pizero1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Confirm and save.&lt;/p&gt;

&lt;p&gt;Next edit this file.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo nano /etc/hosts
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Change the last line to match the entry you placed in the &lt;code&gt;/etc/hostname&lt;/code&gt; file.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;127.0.1.1       pizero1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
Repeat for all your pi zero w boards, and each will be separately identifiable and addressable on your Wifi network.&lt;/p&gt;

&lt;p&gt;For example..&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;ssh pi@pizero1.local
ssh pi@pizero2.local
ssh pi@pizero3.local
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
We&amp;rsquo;re done.&lt;/p&gt;

&lt;h3 id=&#34;step-6-creating-an-image-of-your-work&#34;&gt;Step 6. Creating an image of your work&lt;/h3&gt;

&lt;p&gt;We can&amp;rsquo;t go through this long process - as much fun as it was :/ - every time we want to configure a new Raspberry Pi Zero W, so in this final step we&amp;rsquo;re going to create an image file of everything we&amp;rsquo;ve done so far.&lt;/p&gt;

&lt;p&gt;This image will give us a snapshot of the Operating System and File System, exactly as it is now. One that we can use, in place of the default Raspbian image, when we get another Pi Zero W and need an OS for it.&lt;/p&gt;

&lt;p&gt;With an image, our next setup will just comprise of two simple steps!.&lt;/p&gt;

&lt;p&gt;1) We&amp;rsquo;ll just need to copy the image to a new Micro SD card as we did in Step 1, and then;&lt;/p&gt;

&lt;p&gt;2) log in, and change the hostname just like we did in Step 5.&lt;/p&gt;

&lt;p&gt;Everything else including Wifi, SSH passwordless login and Firewall will be preconfigured out-the-box&lt;/p&gt;

&lt;p&gt;To create the image we use the &lt;code&gt;DD&lt;/code&gt; command from the Mac Terminal application. We unmount the Micro SD card first.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo diskutil unmountdisk /dev/disk2
sudo dd bs=1m if=/dev/rdisk2 of=pi/060317.img
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
This creates the image file &lt;code&gt;060317.img&lt;/code&gt; in the folder &lt;code&gt;pi&lt;/code&gt; relative to the our current working directory.&lt;/p&gt;

&lt;p&gt;To copy this image to a new Micro SD card for use in another Pi Zero W, we use the &lt;code&gt;DD&lt;/code&gt; command again and simply reverse the parameters such that the source is &lt;code&gt;pi/060317.img&lt;/code&gt; and the destination &lt;code&gt;/dev/rdisk2&lt;/code&gt;.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo diskutil unmountdisk /dev/disk2
sudo dd bs=1m if=pi/060317.img of=/dev/rdisk2 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
That&amp;rsquo;s it! We&amp;rsquo;re all done!&lt;/p&gt;

&lt;p&gt;Configuring a Raspberry Pi Zero W from this image is now effortless.&lt;/p&gt;

&lt;h3 id=&#34;potential-stumbling-blocks&#34;&gt;Potential stumbling blocks&lt;/h3&gt;

&lt;p&gt;I&amp;rsquo;ve worked back through this process a couple of times now. I&amp;rsquo;ve had a few issues, which I&amp;rsquo;ve listed here as a heads up.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Unmounting. If you get an unexpected error. Double check the Micro SD card is available, unmounted.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;SD Cards of same size. Turns out they are not always. So a 32GB image written back, to a new 32GB card might not always fit. I&amp;rsquo;ve seen this with a cheap 32GB Micro SD card&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;SD cards of different sizes. Apparently you &lt;a href=&#34;http://raspberrypi.stackexchange.com/questions/1058/is-this-an-ok-way-to-transfer-my-16gb-sd-card-to-an-8gb-sd-card-simple-dd?rq=1&#34;&gt;can write an image taken from a 32GB card back to a 16GB card, or a 16GB to an 8GB&lt;/a&gt;. The data of the pi image is much less than 8GB. You can also do it the other way round, but by default you lose access to the additional space outside the image. Use &lt;code&gt;sudo rasp-config&lt;/code&gt; to expand the root partition to reclaim this space.&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;Imaging takes a while. Unless you really need lots of space, working with 8GB cards is quick, consistent and cheap!&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;SSH known hosts. You might be prompted that an entry exists which doesn&amp;rsquo;t match the new entry if you&amp;rsquo;re SSHing to a new Pi Zero W. Just follow the filepath and delete the line. It will then work fine.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
    <item>
      <title>A little bit of Web Bluetooth</title>
      <link>https://slippytrumpet.io/posts/a-little-bit-of-web-bluetooth/</link>
      <pubDate>Thu, 09 Feb 2017 15:08:26 +0100</pubDate>
      
      <guid>https://slippytrumpet.io/posts/a-little-bit-of-web-bluetooth/</guid>
      <description>

&lt;h2 id=&#34;communicating-using-the-bluetooth-protocol-has-traditionally-been-the-sole-preserve-of-native-applications-now-you-can-do-it-from-a-web-page&#34;&gt;Communicating using the Bluetooth protocol has traditionally been the sole preserve of native applications. Now you can do it from a web page!&lt;/h2&gt;

&lt;p&gt;This is the first of two short posts on my experiments with &lt;a href=&#34;http://www.espruino.com/Puck.js&#34;&gt;Puck.js&lt;/a&gt; and &lt;a href=&#34;https://developers.google.com/web/updates/2015/07/interact-with-ble-devices-on-the-web#before_we_start&#34;&gt;Web Bluetooth&lt;/a&gt;. This one looks at security; the second will look at a &lt;a href=&#34;https://olliephillips.github.io/webbleMQ/&#34;&gt;Web Bluetooth to MQTT gateway&lt;/a&gt; experiment.&lt;/p&gt;

&lt;h3 id=&#34;what-s-web-bluetooth&#34;&gt;What&amp;rsquo;s Web Bluetooth?&lt;/h3&gt;

&lt;p&gt;Some may know, that from Google Chrome v56, the Web Bluetooth API went from being an experimental &amp;ldquo;opt-in&amp;rdquo; feature to enabled by default. It supports communication between devices that implement Bluetooth 4.0 (and above) and uses Bluetooth Low Energy (BLE), a more power efficient protocol.&lt;/p&gt;

&lt;p&gt;As stated in the introduction earlier, once the preserve of native applications, now Web Developers can build applications which talk to physical hardware over BLE from websites - applications which match the capabilities of native apps.&lt;/p&gt;

&lt;p&gt;This is exciting.&lt;/p&gt;

&lt;h3 id=&#34;is-it-secure&#34;&gt;Is it secure?&lt;/h3&gt;

&lt;p&gt;Since the Chrome 56 release, some &lt;a href=&#34;https://www.theregister.co.uk/2017/02/05/chrome_56_quietly_added_bluetooth_snitch_api/&#34;&gt;reports have cited security and privacy concerns&lt;/a&gt;, and many people are clamouring to turn the feature off.&lt;/p&gt;

&lt;p&gt;But should they be concerned? In my view, no.&lt;/p&gt;

&lt;p&gt;It&amp;rsquo;s easy to surmise that unscrupulous website owners might try and take advantage of this; that device detection could be used as a mechanism for tracking - just like cookies - but the mechanics of the Web Bluetooth API seem to have security firmly in mind. It looks like it would be hard to abuse from an application, both intentionally and inadvertently.&lt;/p&gt;

&lt;p&gt;First, it&amp;rsquo;s HTTPS only. You can&amp;rsquo;t use Web Bluetooth unless your website is served securely.&lt;/p&gt;

&lt;p&gt;Second, to initiate a device scan, it has to be in response to a user action such as a mouse click or finger swipe. You can&amp;rsquo;t trigger it directly from code - and you can&amp;rsquo;t emulate these events programmatically to fool the Web Bluetooth API.&lt;/p&gt;

&lt;p&gt;However, one might argue that website visitors could be fooled.&lt;/p&gt;

&lt;p&gt;For example, what if you attach an &lt;code&gt;onClick&lt;/code&gt; event listener to the &lt;code&gt;&amp;lt;body&amp;gt;&lt;/code&gt; element of the DOM? Would a mouse click anywhere on the page initiate a device scan?&lt;/p&gt;

&lt;p&gt;It would.&lt;/p&gt;

&lt;p&gt;But hold your horses, so you can do this, is there any real risk? I&amp;rsquo;d say &amp;lsquo;no&amp;rsquo; again.&lt;/p&gt;

&lt;p&gt;To understand why, we need to look at what happens next. We need to look at how a device scan works; how does it notify the user  of devices in range which it can connect to, and; more importantly, at what stage does the browser have access to any information about these devices (specifically, we&amp;rsquo;re concerned about information exposed by the Web Bluetooth API object - about scanned devices - which could be stored, used for connection attempts, reading &lt;a href=&#34;https://www.bluetooth.com/specifications/gatt/characteristics&#34;&gt;service characteristics&lt;/a&gt;, or just just &amp;lsquo;plain evil&amp;rsquo; tracking?&lt;/p&gt;

&lt;p&gt;Let&amp;rsquo;s see.&lt;/p&gt;

&lt;p&gt;This code initiates a Web Bluetooth device scan. You have to set it up as callback to an event listener like &lt;code&gt;click&lt;/code&gt;, but once the event triggers, a &amp;lsquo;device chooser&amp;rsquo; pop-up will appear near the address bar of the Chrome Browser listing devices in range.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;navigator.bluetooth.requestDevice({
	acceptAllDevices: true
}).then(device =&amp;gt; { 
	console.log(device)
}).catch(error =&amp;gt; { console.log(error);});
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;&lt;/p&gt;

&lt;p&gt;The above will list all BLE devices in range, but in your application, you can define filters so that only the types of device your app can interact with, will appear. For example, use a name prefix if devices have a common name, or you can filter on &lt;a href=&#34;https://www.bluetooth.com/specifications/gatt/services&#34;&gt;GATT service&lt;/a&gt; (GATT represents &amp;ldquo;Generic Attribute Profile&amp;rdquo;, and broadly put, GATT services describe what a device is able to do).&lt;/p&gt;

&lt;p&gt;Following the scan, the user is able to pick the device they want the web page to connect to, but until they do, our script can&amp;rsquo;t process code to connect, and our script/web page knows NOTHING about the devices in the device chooser, the devices in range.&lt;/p&gt;

&lt;p&gt;Also that &amp;lsquo;device chooser&amp;rsquo;.. it&amp;rsquo;s a part of the Chrome browser application, and nothing to do with the webpage and its DOM. So you can&amp;rsquo;t interact with it from code.&lt;/p&gt;

&lt;p&gt;From here the user can choose a device, or cancel. I&amp;rsquo;ve noticed ignoring the device chooser and doing something else like opening the Developer Console will trigger &amp;lsquo;cancel&amp;rsquo; too - I don&amp;rsquo;t know what other actions will do this.&lt;/p&gt;

&lt;p&gt;In the above code &amp;lsquo;cancelling&amp;rsquo;, however activated, will cause an error to be logged to console.&lt;/p&gt;

&lt;p&gt;If the user chooses to connect to a device, then a &lt;code&gt;BluetoothDevice&lt;/code&gt; object is passed to the script which, for my Puck device, contains the following information.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;BluetoothDevice {
	id: &amp;quot;0L3/Rdv+ZzblpiXmJPlO3A==&amp;quot;, 
	name: &amp;quot;Puck.js bb18&amp;quot;, 
	gatt: BluetoothRemoteGATTServer, 
	ongattserverdisconnected: null
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
But, remember, I allowed the web application to see this, by allowing my browser to connect to it.&lt;/p&gt;

&lt;p&gt;This device scan &amp;amp; connection process must be followed every time the user wants to connect a device - as far as I can tell there is no memorizing, nor any pairing.&lt;/p&gt;

&lt;p&gt;So this looks fairly secure to me. Hard for web developers to abuse.&lt;/p&gt;

&lt;p&gt;Can networks of websites leverage Web Bluetooth? Like they might do cookies?&lt;/p&gt;

&lt;p&gt;I don&amp;rsquo;t know, but in my testing, the &lt;code&gt;BluetoothDevice.id&lt;/code&gt; is not a constant. It seems to be random and rotates on connection. So, if trying to track JUST allowed/connected devices, you could not rely on &lt;code&gt;id&lt;/code&gt; website to website. &lt;code&gt;BluetoothDevice.name&lt;/code&gt; can be constant though.&lt;/p&gt;

&lt;p&gt;Can Google see any data&amp;hellip;? What if you compromise Chrome&amp;hellip;? Is the API secure&amp;hellip;? We&amp;rsquo;ll all know in time.&lt;/p&gt;

&lt;p&gt;But, the last point I want to make on Web Bluetooth, is that where Web Bluetooth offers no data on, nor any programmatic access to, devices in range.. a native app, written in Node, Go, C or similar, running on hardware as accessible and cheap as a Raspberry Pi 3, will give you a lot of info - without asking for any permission whatsoever!&lt;/p&gt;

&lt;p&gt;So, if you&amp;rsquo;re going to be tracked unknowingly via your Bluetooth devices, it&amp;rsquo;s less likely to be via a website, than from a cheap home built Bluetooth scanner, running out of someone&amp;rsquo;s living room.&lt;/p&gt;

&lt;h3 id=&#34;so-that-said-what-can-you-do-with-web-bluetooth&#34;&gt;So, that said, what can you do with Web Bluetooth?&lt;/h3&gt;

&lt;p&gt;Since security is the general theme of this post, I&amp;rsquo;ve built a totally impractical 2 factor authentication demo which uses Puck.js as a hardware fob to authenticate the user, a bit like how the banks do with online account access.&lt;/p&gt;

&lt;p&gt;It&amp;rsquo;s impractical since it&amp;rsquo;s all client side, so not secure, but some server calls could remedy this. But you&amp;rsquo;d still need a Puck to use it!&lt;/p&gt;

&lt;p&gt;You can see the &lt;a href=&#34;https://olliephillips.github.io/areyoupucker/&#34;&gt;interface here&lt;/a&gt;. The website sends a random four colour sequence to the Puck (which has three onboard LEDs - Red, Green and Blue).&lt;/p&gt;

&lt;p&gt;The sequence, once replicated on the web form interface, unlocks the form so that it can be submitted.&lt;/p&gt;

&lt;p&gt;Video below shows how it works.&lt;/p&gt;

&lt;p&gt;&lt;blockquote class=&#34;instagram-media&#34; data-instgrm-captioned data-instgrm-version=&#34;7&#34; style=&#34; background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);&#34;&gt;&lt;div style=&#34;padding:8px;&#34;&gt; &lt;div style=&#34; background:#F8F8F8; line-height:0; margin-top:40px; padding:50.0% 0; text-align:center; width:100%;&#34;&gt; &lt;div style=&#34; background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAMUExURczMzPf399fX1+bm5mzY9AMAAADiSURBVDjLvZXbEsMgCES5/P8/t9FuRVCRmU73JWlzosgSIIZURCjo/ad+EQJJB4Hv8BFt+IDpQoCx1wjOSBFhh2XssxEIYn3ulI/6MNReE07UIWJEv8UEOWDS88LY97kqyTliJKKtuYBbruAyVh5wOHiXmpi5we58Ek028czwyuQdLKPG1Bkb4NnM+VeAnfHqn1k4+GPT6uGQcvu2h2OVuIf/gWUFyy8OWEpdyZSa3aVCqpVoVvzZZ2VTnn2wU8qzVjDDetO90GSy9mVLqtgYSy231MxrY6I2gGqjrTY0L8fxCxfCBbhWrsYYAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;&#34;&gt;&lt;/div&gt;&lt;/div&gt; &lt;p style=&#34; margin:8px 0 0 0; padding:0 4px;&#34;&gt; &lt;a href=&#34;https://www.instagram.com/p/BQTLhASA27a/&#34; style=&#34; color:#000; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none; word-wrap:break-word;&#34; target=&#34;_blank&#34;&gt;Are you pucker?&lt;/a&gt;&lt;/p&gt; &lt;p style=&#34; color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;&#34;&gt;A video posted by Ollie (@slippytrumpet) on &lt;time style=&#34; font-family:Arial,sans-serif; font-size:14px; line-height:17px;&#34; datetime=&#34;2017-02-09T17:44:45+00:00&#34;&gt;Feb 9, 2017 at 9:44am PST&lt;/time&gt;&lt;/p&gt;&lt;/div&gt;&lt;/blockquote&gt;
&lt;script async defer src=&#34;//platform.instagram.com/en_US/embeds.js&#34;&gt;&lt;/script&gt;&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;ve also written a &lt;a href=&#34;https://olliephillips.github.io/webbleMQ/&#34;&gt;Web Bluetooth MQTT gateway&lt;/a&gt; which facilitates master/slave communication between Pucks, console control of multiple Pucks at the same time, as well as communication of data over MQTT.&lt;/p&gt;

&lt;p&gt;I will cover this in another post.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Building a Remote Control Car with Espruino on ESP8266</title>
      <link>https://slippytrumpet.io/posts/building-an-rc-car-with-espruino-on-esp8266/</link>
      <pubDate>Wed, 16 Nov 2016 09:18:08 +0000</pubDate>
      
      <guid>https://slippytrumpet.io/posts/building-an-rc-car-with-espruino-on-esp8266/</guid>
      <description>

&lt;h2 id=&#34;a-broken-radio-controlled-microcar-just-lying-in-a-box-useless-a-little-knowledge-of-espruino-and-winter-nights-closing-in&#34;&gt;A broken radio controlled microcar; just lying in a box, useless. A little knowledge of Espruino and winter nights closing in.&lt;/h2&gt;

&lt;h2 id=&#34;we-can-make-this-car-work-again-but-over-wifi-i-told-the-kids-and-that-was-my-first-mistake&#34;&gt;&amp;ldquo;We can make this car work again - but over Wifi&amp;rdquo;, I told the kids. And that was my first mistake.&lt;/h2&gt;

&lt;p&gt;First, one of those, &amp;ldquo;blimey this is a long post; maybe I won&amp;rsquo;t bother&amp;rdquo; things.. AKA &amp;ldquo;TL;DR&amp;rdquo;.&lt;/p&gt;

&lt;p&gt;Espruino/JavaScript code which runs on a NodeMCU ESP8266 microcontroller and does this..&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Provides motor and steering control functions on NodeMCU ESP8266 pins connected to a dual H-bridge module;&lt;/li&gt;
&lt;li&gt;Includes a HTML page to serve which allows us to control the car from a Smartphone on the same Wifi network (tested on iPhone);&lt;/li&gt;
&lt;li&gt;Creates a http/websocket server, which serves the HTML page in (2) and creates a websocket connection which listens for message events from (2) and passes them to (1);
&lt;br/&gt;&lt;br/&gt;
..can be &lt;a href=&#34;https://github.com/olliephillips/espruinoCar&#34;&gt;found here&lt;/a&gt;.
&lt;br/&gt;&lt;br/&gt;
You&amp;rsquo;re still here? Excellent.&lt;/li&gt;
&lt;/ol&gt;

&lt;h2 id=&#34;what-is-espruino&#34;&gt;What is Espruino?&lt;/h2&gt;

&lt;p&gt;Let&amp;rsquo;s cover this first. &lt;a href=&#34;http://www.espruino.com&#34;&gt;Espruino&lt;/a&gt; is a JavaScript interpreter on a microcontroller.&lt;/p&gt;

&lt;p&gt;The project itself comprises both the official microcontroller hardware - there are three different boards: &lt;a href=&#34;http://www.espruino.com/Order&#34;&gt;Espruino, Espruino Pico, and the latest, Espruino Wifi&lt;/a&gt; - and the firmware binary which is a C application that gets flashed (written) to the microcontroller.&lt;/p&gt;

&lt;p&gt;The microcontroller boards have a number of pins that can be written to and read from - their voltage determining their state. The pins can be connected to &amp;ldquo;things&amp;rdquo; so you can literally write JavaScript to control them.&lt;/p&gt;

&lt;p&gt;Espruino is open source, the firmware can be freely downloaded and there are builds for other microcontrollers based on a similar chip architecture. There are even builds for Linux, so you could use Espruino with a Raspberry Pi.&lt;/p&gt;

&lt;p&gt;Implementations vary though. Some builds may not give you all the features of Espruino, and only the official Espruino boards are fully supported and guaranteed to work &amp;ldquo;out-the-box&amp;rdquo;. It&amp;rsquo;s also worth noting that some boards won&amp;rsquo;t offer as much memory as the official boards which can limit their usefulness for some applications.&lt;/p&gt;

&lt;p&gt;For this project I used an ESP8266 NodeMCU development board. They are cheap, have built in Wifi, and enough memory for my application.&lt;/p&gt;

&lt;p&gt;Before I move on, I should emphasise that Espruino is funded through donations and sales of official boards. Though I&amp;rsquo;m choosing ESP8266 here, I own plenty of the original boards - two Espruino, three Picos and one Espruino Wifi in fact.&lt;/p&gt;

&lt;p&gt;When starting out it&amp;rsquo;s a really good idea to get an official board just because they are plug and play. You&amp;rsquo;ll get good support in the &lt;a href=&#34;http://forum.espruino.com&#34;&gt;Espruino forums&lt;/a&gt; too, plus you&amp;rsquo;ll find them useful when prototyping even if your project will eventually run on unofficial hardware.&lt;/p&gt;

&lt;h2 id=&#34;the-objective&#34;&gt;The objective&lt;/h2&gt;

&lt;p&gt;Essentially to drive the car over Wifi, maybe even remotely over the Internet, using a web page to control it. For communications, MQTT was my first inclination since I could leave the RC car behind a firewall, whereas using Websockets and a HTTP server I&amp;rsquo;d have to expose the car to the world via port forwarding. But more on this later.&lt;/p&gt;

&lt;h2 id=&#34;first-attempt&#34;&gt;First attempt&lt;/h2&gt;

&lt;p&gt;Our donor car was a radio controlled microcar not much bigger than a matchbox car - remember those? I think the scale was something like 1:42.&lt;/p&gt;

&lt;p&gt;The steering mechanism of the RC microcar was broken, reason unknown - but it only steered one way. On inspection the steering was operated using two solenoid coils and a magnet on a steering rack. With current applied to each coil the steering rack moved left and right - or should have.&lt;/p&gt;

&lt;p&gt;Without using the circuit board of the RC car, I did not understand how I could control the solenoid setup - even if it wasn&amp;rsquo;t broken, and what if it was the circuit board itself that was faulty?&lt;/p&gt;

&lt;p&gt;So my first decision was to remove the solenoids, magnet and the circuit board from the car.&lt;/p&gt;

&lt;p&gt;In their place I sourced a tiny micro servo on ebay, glued it in and created a simple linkage to the steering rack with stiff wire.&lt;/p&gt;

&lt;p&gt;Steering was sorted, but this was a fiddly job and the addition of the servo made it likely the car&amp;rsquo;s body would not fit back on without modification.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://slippytrumpet.io/images/micro-servo.png&#34; alt=&#34;alt text&#34; title=&#34;Micro servo. Fiddly.&#34; /&gt;
Pictured: Micro servo, attached to steering rack&lt;/p&gt;

&lt;h3 id=&#34;next-issue-drive&#34;&gt;Next issue, &amp;ldquo;drive&amp;rdquo;&lt;/h3&gt;

&lt;p&gt;After some help from a couple of people in the Espruino forums I better understood what was involved in controlling the motor - which required switching the supply polarity to provide forward and reverse motion.&lt;/p&gt;

&lt;p&gt;My first attempt used multiple ESP8266 pins, in pairs which I switched as groups between high and low state, essentially wiring them in parallel to hopefully provide sufficient current to drive the motor.&lt;/p&gt;

&lt;p&gt;Unfortunately this didn&amp;rsquo;t work.  The motor was rated 75mA at 4.5v. The ESP8266 NodeMCU board could supply 12mA at 3.7v per pin. I wasn&amp;rsquo;t going to have enough pins to get that current.&lt;/p&gt;

&lt;p&gt;At this point I wondered about using my Espruino Wifi instead, which I believe can provide 20mA per pin, possibly enough when grouped in parallel. And maybe I would have gone this route, had discussion in the forums not focussed my attention on something call a &amp;ldquo;H-bridge&amp;rdquo;.&lt;/p&gt;

&lt;p&gt;A H-bridge is a circuit which operates like a 3 way switch. It allows polarity of voltage to be reversed, which when connected to a motor, rotates it in opposing directions - forward and reverse for our purposes.&lt;/p&gt;

&lt;p&gt;After more discussion, and the prospect of making a H-bridge circuit myself from the component parts, I chickened out and went back to ebay where I found a dual H-bridge module for about 1.50 delivered. To control our motor we needed only one of the H-bridge channels.&lt;/p&gt;

&lt;p&gt;But there was no way the car&amp;rsquo;s shell was going to fit back on now, modified or not.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://slippytrumpet.io/images/h-bridge-with-motor.png&#34; alt=&#34;alt text&#34; title=&#34;H-bridge attached to motor&#34; /&gt;
Pictured: L9110S Dual H-bridge module&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;m not going to cover wiring, pin selection nor code yet, since this is not how the car ended up and could confuse.&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;ll cover all this later, but here&amp;rsquo;s the finished &amp;ldquo;first attempt&amp;rdquo;. Now devoid of shell, obviously I went to a lot of trouble to make it look like a car again. Check that rear spoiler out!&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://slippytrumpet.io/images/microcar.png&#34; alt=&#34;alt text&#34; title=&#34;RC Microcar&#34; /&gt;
Pictured: Micro servo, 3.7v li-ion battery, NodeMCU ESP8266, H-bridge&lt;/p&gt;

&lt;p&gt;At this point we had a working car and a basic code library, which combined allowed us to control the car over Telnet (wireless console) to send stop/go/direction commands.&lt;/p&gt;

&lt;p&gt;We got about 20 minutes out of it. Then the car ceased to steer. The micro servo was turning but did not make its stops with the control arm. I had a look inside and it appeared one of the tiny gears had stripped its teeth. I could have ordered a replacement micro servo, but for it to potentially happen again. So this didn&amp;rsquo;t seem like a great idea.&lt;/p&gt;

&lt;p&gt;Fortunately, my kids were now interested enough in the potential of the project, that they donated another RC car.&lt;/p&gt;

&lt;p&gt;Actually they sold it to me :/&lt;/p&gt;

&lt;h2 id=&#34;second-attempt&#34;&gt;Second attempt&lt;/h2&gt;

&lt;p&gt;One bit of feedback from my kids. Despite my efforts, it didn&amp;rsquo;t look like a car. The broken RC microcar was previously a Lamborghini but look what I had turned it into - a monster.&lt;/p&gt;

&lt;p&gt;Fortunately, the new donor vehicle, a Mini, was much bigger. We would have no issues with space or refitting the shell.&lt;/p&gt;

&lt;p&gt;Two other plus points: first, steering on this car was motor driven. I wouldn&amp;rsquo;t need to add a servo or scratch my head over solenoids, we could use the second channel of the H-bridge to control the steering motor and second; power. The car carried 4 AA batteries, so supplied 6v. I could run that to the 5v power input on the NodeMCU board and we would have enough for everything.&lt;/p&gt;

&lt;h2 id=&#34;building&#34;&gt;Building&lt;/h2&gt;

&lt;p&gt;Building the second car was almost trivial. Most of the learning had been done with the first car, and there was so much room to play with.&lt;/p&gt;

&lt;p&gt;Power was from the batteries and the two motors had wires we easilly extended and routed to the two channels of the H-bridge. All the components were mounted with hot glue.&lt;/p&gt;

&lt;p&gt;Wiring had to be modified slightly to accomodated a second motor attached to the H-bridge, but this second build probably only took about 30 minutes.&lt;/p&gt;

&lt;p&gt;We added a buzzer to work as a horn which, as well as being controllable over wifi, we decided would serve to notify us once the car had successfully connected to the Wifi network - there&amp;rsquo;d be no point trying to control the car until it had.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://slippytrumpet.io/images/mini.png&#34; alt=&#34;alt text&#34; title=&#34;Mini&#34; /&gt;
Pictured: RC Mini shell and floorpan, with the NodeMCU and H-bridge module and buzzer glued in.&lt;/p&gt;

&lt;p&gt;The code library also needed to be modified to control the steering. You can find the &lt;a href=&#34;https://github.com/olliephillips/espruinoCar&#34;&gt;full library on Github here&lt;/a&gt;, but here&amp;rsquo;s the control piece.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;// Control methods for espruinoCar &#39;ec&#39;
var ec = {
  pin: {
    forward: D4,
    reverse: D5,
    left: D14,
    right: D0,
    horn: D12
  },
  left: function() {
    digitalWrite(ec.pin.left, 1);
    digitalWrite(ec.pin.right, 0);
  },
  right: function() {
    digitalWrite(ec.pin.right, 1);
    digitalWrite(ec.pin.left, 0);
  },
  ahead : function() {
    digitalWrite(ec.pin.left, 0);
    digitalWrite(ec.pin.right, 0);
  },
  drive: function(speed, time){
    if(time){
      setTimeout(function(){
        analogWrite(ec.pin.forward, 0);
      }, ec.convert.time(time));
    }
    analogWrite(ec.pin.forward, ec.convert.speed(speed)); 
    analogWrite(ec.pin.reverse, 0);
  },
  reverse: function(speed, time) {
    if(time){
      setTimeout(function(){
        analogWrite(ec.pin.reverse, 0);
      }, ec.convert.time(time));
    }
    analogWrite(ec.pin.reverse, ec.convert.speed(speed)); 
    analogWrite(ec.pin.forward, 0);
  },
  stop: function() {
    analogWrite(ec.pin.forward, 0);
    analogWrite(ec.pin.reverse, 0);
    digitalWrite(ec.pin.left, 0);
    digitalWrite(ec.pin.right, 0); 
  },
  horn: {
    toot: function() {
      setTimeout(function(){
         digitalPulse(ec.pin.horn, 1, 200);
      },300);
      digitalPulse(ec.pin.horn, 1, 200);
    },
    honk: function() {
      digitalPulse(ec.pin.horn, 1, 1000);
    }
  },
  init: function() {
    pinMode(ec.pin.left, &amp;quot;output&amp;quot;);
    pinMode(ec.pin.right, &amp;quot;output&amp;quot;);
    pinMode(ec.pin.forward, &amp;quot;output&amp;quot;);
    pinMode(ec.pin.reverse, &amp;quot;output&amp;quot;);
    pinMode(ec.pin.horn, &amp;quot;output&amp;quot;);
    analogWrite(ec.pin.forward, 0);
    analogWrite(ec.pin.reverse, 0);
    digitalWrite(ec.pin.left, 0);
    digitalWrite(ec.pin.right, 0); 
  },
  convert: {
    speed : function(speed) {
              var convSpeed = speed/100;
              return convSpeed;
    },
    time : function(time) {
             var convTime = time* 1000;
             return convTime;
    }
  }
};
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;
One thing to note. The pin numbers on the NodeMCU board do not relate to the GPIO pin numbers you need to access them via Espruino, which makes wiring more complicated than it should be.  So for clarity the pin references in the excerpt above all relate to the GPIO pin numbers, not the numbers printed on the board.&lt;/p&gt;

&lt;p&gt;The code is fairly self-explanatory I should think. The drive and reverse methods accept &lt;code&gt;speed&lt;/code&gt; and &lt;code&gt;time&lt;/code&gt; arguments, so the car can be programmed to cover a course with this library alone should we wish.&lt;/p&gt;

&lt;p&gt;There are also two utility functions; one which relates speed to a number between 0 and 1, the parameter range for the &lt;code&gt;analogWrite()&lt;/code&gt; function and a second, which converts time to a number in milliseconds for the &lt;code&gt;setTimeout()&lt;/code&gt; function.&lt;/p&gt;

&lt;h2 id=&#34;communicating-over-mqtt&#34;&gt;Communicating over MQTT&lt;/h2&gt;

&lt;p&gt;I mentioned earlier that we wanted to control the RC car over Wifi, possibly remotely over the web too.&lt;/p&gt;

&lt;p&gt;MQTT seemed a good choice for communication. The RC car could subscribe (listen) to a topic on a MQTT broker (of which there are many free/test ones) and our client on iPhone would publish short control messages to the MQTT broker via a websocket connection.&lt;/p&gt;

&lt;p&gt;The advantage was that we didn&amp;rsquo;t need a direct HTTP connection to the car - something that could be abused. With MQTT the RC car would not serve anything but instead simply listen for messages. It could do this from behind the Wifi router&amp;rsquo;s firewall too.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://slippytrumpet.io/images/mqtt.png&#34; alt=&#34;alt text&#34; title=&#34;MQTT testing&#34; /&gt;
Pictured: Publishing control messages to our RC car.&lt;/p&gt;

&lt;p&gt;However I decided it was unlikely we&amp;rsquo;d control the car over the Internet in reality, so it would be sufficient to either connect the RC Car to Wifi, or run the ESP8266 NodeMCU as an access point - whereby it creates a Wifi network we can join, and can expose HTTP on the IP address &lt;code&gt;192.168.4.1&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Using the ESP8266 as an access point would necessitate that it serve all the code and assets we&amp;rsquo;d need for our web based control panel too. While possible this would be significantly more complex, since there&amp;rsquo;s no filesystem on Espruino as such. We&amp;rsquo;d need to persist the assets by writing them to flash memory and we&amp;rsquo;d need to serve them by reading them back from flash memory.&lt;/p&gt;

&lt;p&gt;So I elected to use the ESP8266 in station mode, connecting to an existing Wifi network so that any client accessing the HTML control panel page could download the assets required by the page from the Internet.&lt;/p&gt;

&lt;p&gt;We&amp;rsquo;d still use websockets to send data, but to a websocket server running on the ESP8266 rather than relaying via an MQTT broker.&lt;/p&gt;

&lt;h2 id=&#34;the-controller&#34;&gt;The Controller&lt;/h2&gt;

&lt;p&gt;First things first. Since there was no display on the car, and no communication about the Wifi connection other than a horn toot when connected, it would be helpful to know the IP address in advance.&lt;/p&gt;

&lt;p&gt;Typically routers will assign IP addresses on a &amp;ldquo;first come first served&amp;rdquo; basis, meaning our car&amp;rsquo;s IP address would be random, depending on what else was on the network when we switched it on. With no display we&amp;rsquo;d either have to guess it or connect to the Router every time to determine it.&lt;/p&gt;

&lt;p&gt;There&amp;rsquo;s a better way - so the first thing I did was connect the ESP8266 NodeMCU to my Wifi network. Once identified in the Router control panel, I assigned it a specific &amp;lsquo;reserved&amp;rsquo; IP address.&lt;/p&gt;

&lt;p&gt;Now it would always join the network on the same IP address, so I knew how to reliably connect to the HTTP/Websocket server I was about to write.&lt;/p&gt;

&lt;h3 id=&#34;introducing-iotui-js&#34;&gt;Introducing iotUI.js&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/olliephillips/iotUI.js&#34;&gt;iotUI.js&lt;/a&gt; is a suite of web component controls that I started writing last year. The controls up until this point were mainly aimed at beer brewing so included things like a thermometer and level guages. The interfaces themselves are SVG graphics, which respond to touch and mouse events.&lt;/p&gt;

&lt;p&gt;iotUI.js is built on &lt;a href=&#34;http://riotjs.com&#34;&gt;Riot.js&lt;/a&gt;, which is like React, but much easier to get along with in my opinion. As a library it&amp;rsquo;s also more lightweight than React.&lt;/p&gt;

&lt;p&gt;Riot.js allows us to create custom HTML components referred to as &amp;ldquo;tags&amp;rdquo; and specify all the logic for how the control works in the tag itself.&lt;/p&gt;

&lt;p&gt;To cut what could be a long story, short, all the complexity of adding, interfacing and interacting with the component is abstracted away from the end user. Adding a Riot component to your HTML page that may take input, or trigger events is pretty much as simple as adding a single HTML tag.&lt;/p&gt;

&lt;p&gt;I decided to build my control interface with Riot.js, but then went a step further and implemented the component - &lt;a href=&#34;https://rawgit.com/olliephillips/iotUI.js/master/examples/f1wheel.html&#34;&gt;a steering wheel&lt;/a&gt; - in iotUI.js.&lt;/p&gt;

&lt;p&gt;Should you wish, you can easilly implement it in your projects too.&lt;/p&gt;

&lt;p&gt;I must mention that I didn&amp;rsquo;t design this steering wheel from scratch, but modified it for my needs based on this &lt;a href=&#34;https://commons.wikimedia.org/wiki/File:Formula_one_steering_wheel_back.svg&#34;&gt;image here&lt;/a&gt;. As per the Creative Commons share-alike licensing the image is offered under, you can find the &lt;a href=&#34;https://github.com/olliephillips/iotUI.js/blob/master/svg_files/f1-wheel.svg&#34;&gt;modified SVG here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The code for the component is fairly simple; it basically creates event emitters on all the buttons and, using HTML device orientation, a &amp;lsquo;steer&amp;rsquo; event is emitted as the smartphone is rotated like a steering wheel.&lt;/p&gt;

&lt;p&gt;If you&amp;rsquo;re interested in how a Riot component is written you can inspect &lt;a href=&#34;https://github.com/olliephillips/iotUI.js/blob/master/tags/iotui-f1wheel.tag&#34;&gt;the code for the tag here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Adding the component to the page, is a simple as this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;iotui-f1wheel 
  id=&amp;quot;wheel1&amp;quot; wheellabel=&amp;quot;iotUI.js&amp;quot; 
  primarybuttonlabel=&amp;quot;TOOT&amp;quot; 
  startbuttonlabel=&amp;quot;START/STOP&amp;quot; 
  secondarybuttonlabel=&amp;quot;HONK&amp;quot; 
  width=&amp;quot;540&amp;quot;&amp;gt;
&amp;lt;/iotui-f1wheel&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;&lt;br/&gt;
You can see that various attributes can be set to denote, wheel and button labels.&lt;/p&gt;

&lt;p&gt;I&amp;rsquo;ve embedded the actual steering wheel component below - open your web browser&amp;rsquo;s javascript console if you like and give the buttons a go! You&amp;rsquo;ll see all emitted events logged to the console.&lt;/p&gt;

&lt;p&gt;My MacBook Pro also seems to have a tilt sensor - if you&amp;rsquo;re using a MacBook too, try tipping it forwards and away from you. You&amp;rsquo;ll see some steer event changes, albeit not very useful ones.&lt;/p&gt;

&lt;p&gt;&lt;iotui-f1wheel 
  id=&#34;wheel1&#34; wheellabel=&#34;iotUI.js&#34; 
  primarybuttonlabel=&#34;TOOT&#34; 
  startbuttonlabel=&#34;START/STOP&#34; 
  secondarybuttonlabel=&#34;HONK&#34; 
  width=&#34;500&#34;&gt;
&lt;/iotui-f1wheel&gt;&lt;/p&gt;

&lt;p&gt;The entire HTML page, which also includes the websocket connection and event handlers to send control information back to the websocket server running on the NodeMCU connected to our RC car, looks like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;!DOCTYPE html&amp;gt;
&amp;lt;html lang=&amp;quot;en&amp;quot;&amp;gt; 
&amp;lt;head&amp;gt;&amp;lt;meta charset=&amp;quot;utf-8&amp;quot;&amp;gt;&amp;lt;meta name=&amp;quot;viewport&amp;quot; content=&amp;quot;width=device-width, user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0&amp;quot;&amp;gt;
&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;
&amp;lt;iotui-f1wheel id=&amp;quot;wheel1&amp;quot; wheellabel=&amp;quot;iotUI.js&amp;quot; primarybuttonlabel=&amp;quot;TOOT&amp;quot;  startbuttonlabel=&amp;quot;START/STOP&amp;quot; secondarybuttonlabel=&amp;quot;HONK&amp;quot; width=&amp;quot;540&amp;quot;&amp;gt;&amp;lt;/iotui-f1wheel&amp;gt;	
&amp;lt;script&amp;gt;
var ws;
var evnt = {};
ws = new WebSocket(&amp;quot;ws://&amp;quot; + location.host + &amp;quot;/espruinocar&amp;quot;, &amp;quot;protocolOne&amp;quot;);

function ignitionHandler(){
  evnt.type = &amp;quot;ignition&amp;quot;;
  evnt.state = this.state.ignition;
  ws.send(evnt);
}

function driveHandler(){
  evnt.type=&amp;quot;drive&amp;quot;;
  evnt.state = this.state.drive;
  ws.send(evnt);
}

function primaryHandler(){
  evnt.type=&amp;quot;primarybuttonpush&amp;quot;;
  ws.send(evnt);
}

function secondaryHandler(){
  evnt.type=&amp;quot;secondarybuttonpush&amp;quot;;
  ws.send(evnt);
}

function steeringHandler(){
  evnt.type=&amp;quot;steer&amp;quot;;
  evnt.state=this.state.steer;
  ws.send(evnt);
}

window.onload = function(){	
  iotUI.addListener(&#39;wheel1&#39;, &#39;ignition&#39;, ignitionHandler);
  iotUI.addListener(&#39;wheel1&#39;, &#39;primarybuttonpush&#39;, primaryHandler);
  iotUI.addListener(&#39;wheel1&#39;, &#39;secondarybuttonpush&#39;, secondaryHandler);
  iotUI.addListener(&#39;wheel1&#39;, &#39;drive&#39;, driveHandler);
  iotUI.addListener(&#39;wheel1&#39;, &#39;steer&#39;, steeringHandler);
}
&amp;lt;/script&amp;gt;
&amp;lt;script src=&amp;quot;https://rawgit.com/olliephillips/iotUI.js/master/iotUI.js&amp;quot;&amp;gt;&amp;lt;/script&amp;gt;
&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;websocket-server&#34;&gt;Websocket server&lt;/h2&gt;

&lt;p&gt;We&amp;rsquo;re nearly there.&lt;/p&gt;

&lt;p&gt;To recap, we have an Espruino powered RC car; a control library that will send signals to ESP8266 NodeMCU pins; a web component built with Riot.js which will provide a control interface and; a HTML page in which we&amp;rsquo;ll serve the component.&lt;/p&gt;

&lt;p&gt;So to the final piece of the puzzle. We need a HTTP server to serve the HTML page and a websocket server, to listen for websocket messages from our web component, and relay them to our control library.&lt;/p&gt;

&lt;p&gt;First the servers - actually it&amp;rsquo;s just one server since the websockets module for Espruino, which upgrades the connection to a websocket, can also function as a HTTP server and serve our HTML:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;var wifi = require(&amp;quot;Wifi&amp;quot;);
var ap = {
  &amp;quot;ssid&amp;quot;: &amp;quot;wif_ssid&amp;quot;,
  &amp;quot;pwd&amp;quot;: &amp;quot;wifi_password&amp;quot;
};

// Our servePage handler which renders our controls
function servePage(req, res) {
  var page=&#39;&amp;lt;!DOCTYPE html&amp;gt;&amp;lt;html lang=&amp;quot;en&amp;quot;&amp;gt;&amp;lt;head&amp;gt;&amp;lt;meta charset=&amp;quot;utf-8&amp;quot;&amp;gt;&amp;lt;meta name=&amp;quot;viewport&amp;quot;&#39;;
  page+=&#39;content=&amp;quot;width=device-width, user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0&amp;quot;&amp;gt;&amp;lt;/head&amp;gt;&#39;;
  page+=&#39;&amp;lt;body&amp;gt;&amp;lt;iotui-f1wheel id=&amp;quot;wheel1&amp;quot; wheellabel=&amp;quot;EspruinoCar&amp;quot; primarybuttonlabel=&amp;quot;TOOT&amp;quot; startbuttonlabel=&amp;quot;START/STOP&amp;quot;&#39;;
  page+=&#39;secondarybuttonlabel=&amp;quot;HONK&amp;quot; width=&amp;quot;540&amp;quot;&amp;gt;&amp;lt;/iotui-f1wheel&amp;gt;&#39;;
  page+=&#39;&amp;lt;script&amp;gt;var ws;var send={};ws=new WebSocket(&amp;quot;ws://&amp;quot; +&#39;;
  page+=&#39;location.host + &amp;quot;/espruinocar&amp;quot;, &amp;quot;protocolOne&amp;quot;);function ignitionHandler()&#39;;
  page+=&#39;{send.type=&amp;quot;ignition&amp;quot;;send.state=this.state.ignition;ws.send(JSON.stringify(send));console.log(JSON.stringify(send));}function driveHandler()&#39;;
  page+=&#39;{send.type=&amp;quot;drive&amp;quot;;send.state=this.state.drive;ws.send(JSON.stringify(send));console.log(JSON.stringify(send));}function primaryHandler()&#39;;
  page+=&#39;{send.type=&amp;quot;primarybuttonpush&amp;quot;;send.state=null;ws.send(JSON.stringify(send));console.log(JSON.stringify(send));}function secondaryHandler()&#39;;
  page+=&#39;{send.type=&amp;quot;secondarybuttonpush&amp;quot;;send.state=null;ws.send(JSON.stringify(send));console.log(JSON.stringify(send));}function steeringHandler()&#39;;
  page+=&#39;{send.type=&amp;quot;steer&amp;quot;;send.state=this.state.steer;ws.send(JSON.stringify(send));console.log(JSON.stringify(send));}window.onload=function(){&#39;;
  page+=&#39;iotUI.addListener(&amp;quot;wheel1&amp;quot;, &amp;quot;ignition&amp;quot;, ignitionHandler);iotUI.addListener(&amp;quot;wheel1&amp;quot;, &amp;quot;primarybuttonpush&amp;quot;,&#39;;
  page+=&#39;primaryHandler);iotUI.addListener(&amp;quot;wheel1&amp;quot;, &amp;quot;secondarybuttonpush&amp;quot;, secondaryHandler);iotUI.addListener(&amp;quot;wheel1&amp;quot;,&#39;;
  page+=&#39;&amp;quot;drive&amp;quot;, driveHandler);iotUI.addListener(&amp;quot;wheel1&amp;quot;, &amp;quot;steer&amp;quot;, steeringHandler);}&amp;lt;/script&amp;gt;&#39;;
  page+=&#39;&amp;lt;script src=&amp;quot;https://rawgit.com/olliephillips/iotUI.js/master/iotUI.js&amp;quot;&amp;gt;&amp;lt;/script&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;&#39;;
  res.writeHead(200, {&#39;Content-Type&#39;: &#39;text/html&#39;});
  res.end(page);
}

// Start everything
function initCar() {
  // Initialise pins
  ec.init();

  // Wifi connection
  wifi.connect(ap.ssid, {&amp;quot;password&amp;quot;: ap.pwd}, function(err){
    if(!err){
      var server = require(&#39;ws&#39;).createServer(servePage);
      server.listen(8000);
      server.on(&amp;quot;websocket&amp;quot;, function(ws) {
        ws.on(&#39;message&#39;, function(evt){
          var ev = JSON.parse(evt);
          controlMap(ev);
        });
      });

      // Signal connected to wifi
      ec.horn.toot();
    }
  });
}

// Start up from boot
E.on(&amp;quot;init&amp;quot;, initCar);
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;&lt;br/&gt;
Next, the &lt;code&gt;controlMap(evt)&lt;/code&gt; function into which we pass the websocket event message, an object with two properties &amp;lsquo;type&amp;rsquo; and &amp;lsquo;state&amp;rsquo;, and in which there is logic which maps the event to the control library (ec):&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;// Maps events received over websocket to ec object controls
function controlMap(event){
  var forwardSpeed = 70;
  var reverseSpeed = 40;
  console.log(&amp;quot;message:&amp;quot; +  event.type +&amp;quot;:&amp;quot; + event.state);
  switch (event.type){
    case &amp;quot;ignition&amp;quot;:
      if (event.state == &amp;quot;off&amp;quot;){ec.stop();}
    break;
    case &amp;quot;steer&amp;quot;:
      switch(event.state){
        case &amp;quot;left&amp;quot;:
          ec.left();
        break;
        case &amp;quot;neutral&amp;quot;:
          ec.ahead();
        break;
        case &amp;quot;right&amp;quot;:
          ec.right();
        break;
      }
    break;
    case &amp;quot;drive&amp;quot;:
      switch(event.state){
        case &amp;quot;stop&amp;quot;:
          ec.stop();
        break;
        case &amp;quot;forward&amp;quot;:
          ec.drive(forwardSpeed);
        break;
        case &amp;quot;reverse&amp;quot;:
          ec.reverse(reverseSpeed);
        break;
      }
    break;
    case &amp;quot;primarybuttonpush&amp;quot;:
      ec.horn.toot();
    break;
    case &amp;quot;secondarybuttonpush&amp;quot;:
      ec.horn.honk();
    break;
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;br/&gt;&lt;br/&gt;
And that&amp;rsquo;s it!&lt;/p&gt;

&lt;p&gt;All that remains is to upload this code to our ESP8266 on the RC Car, and then save it using &lt;code&gt;save()&lt;/code&gt; in the console on the left of the Espruino Web IDE. Now whenever the car starts the &lt;code&gt;E.on(&amp;quot;init&amp;quot;, initCar)&lt;/code&gt; piece will run our &lt;code&gt;initCar&lt;/code&gt; function and the car will connect to the Wifi network.&lt;/p&gt;

&lt;p&gt;So we disconnect USB, and switch on the car.&lt;/p&gt;

&lt;p&gt;Wait for the horn toot, then connect to &lt;code&gt;http://192.168.0.19:8000&lt;/code&gt; from our smartphone browser and off we go!&lt;/p&gt;

&lt;p&gt;Actually there&amp;rsquo;s a small gotcha on iPhone. Browsers on iPhone, whether Safari, Chrome or Firefox are all based on Webkit, which does not support the HTTP/1.0 standard, at least not for the purpose of upgrading the connection to websocket, but HTTP/1.0 is the standard used by Espruino.&lt;/p&gt;

&lt;p&gt;You can fix this by taking a HEX editor to the Espruino binary and replacing all text instances of &amp;ldquo;HTTP/1.0&amp;rdquo; of which there are two, with &amp;ldquo;HTTP/1.1&amp;rdquo;. This is enough to bamboozle the browser into thinking it&amp;rsquo;s a HTTP/1.1 standard connection, and it seems to upgrade it to websocket with no apparent detrimental side effects.&lt;/p&gt;

&lt;p&gt;Flash the customized binary to your ESP8266 and you are away. Thanks to Gordon Williams, the man behind Espruino itself, for that clever idea!&lt;/p&gt;

&lt;p&gt;Don&amp;rsquo;t forget, if some of the above code snippets are not that clear, &lt;a href=&#34;https://github.com/olliephillips/espruinoCar&#34;&gt;all the code is available here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Finally, my favorite picture if not the best quality one. My two youngest driving their Espruino powered remote control car.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;https://slippytrumpet.io/images/drive-it.png&#34; alt=&#34;alt text&#34; title=&#34;First drive&#34; /&gt;
Pictured: First drive of our Espruino Wifi remote control car.&lt;/p&gt;

&lt;p&gt;Have fun!&lt;/p&gt;

&lt;script&gt;
var evnt = {}
function output(evnt) {
  console.log(&#34;Event: &#39;&#34; + evnt.type + &#34;&#39; fired. State: &#39;&#34; + evnt.state + &#34;&#39;&#34;);
}

function ignitionHandler(){
  evnt.type = &#34;ignition&#34;;
  evnt.state = this.state.ignition;
  output(evnt);
}

function driveHandler(){
  evnt.type=&#34;drive&#34;;
  evnt.state = this.state.drive;
  output(evnt);
}

function primaryHandler(){
  evnt.type=&#34;primarybuttonpush&#34;;
  output(evnt);
}

function secondaryHandler(){
  evnt.type=&#34;secondarybuttonpush&#34;;
  output(evnt);
}

function steeringHandler(){
  evnt.type=&#34;steer&#34;;
  evnt.state=this.state.steer;
  output(evnt);
}

window.onload = function(){ 
  iotUI.addListener(&#39;wheel1&#39;, &#39;ignition&#39;, ignitionHandler);
  iotUI.addListener(&#39;wheel1&#39;, &#39;primarybuttonpush&#39;, primaryHandler);
  iotUI.addListener(&#39;wheel1&#39;, &#39;secondarybuttonpush&#39;, secondaryHandler);
  iotUI.addListener(&#39;wheel1&#39;, &#39;drive&#39;, driveHandler);
  iotUI.addListener(&#39;wheel1&#39;, &#39;steer&#39;, steeringHandler);
}
&lt;/script&gt;
&lt;script src=&#34;https://rawgit.com/olliephillips/iotUI.js/master/iotUI.js&#34;&gt;&lt;/script&gt;
</description>
    </item>
    
  </channel>
</rss>